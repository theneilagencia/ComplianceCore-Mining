name: Radar Health Check & Backup

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  health-check:
    name: Radar System Health Check
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/dev'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run health check
        id: health
        run: |
          node -e "
          const { getDiagnostic } = require('./server/modules/radar/services/dataAggregator');
          
          (async () => {
            try {
              const sources = await getDiagnostic();
              const active = sources.filter(s => s.status === 'active').length;
              const total = sources.length;
              const errorCount = sources.filter(s => s.status === 'error').length;
              
              console.log('::set-output name=active::' + active);
              console.log('::set-output name=total::' + total);
              console.log('::set-output name=errors::' + errorCount);
              
              console.log(\`‚úÖ Health Check: \${active}/\${total} sources active, \${errorCount} errors\`);
              
              if (errorCount > total / 2) {
                console.error('‚ùå CRITICAL: More than 50% of sources are down!');
                process.exit(1);
              }
            } catch (error) {
              console.error('‚ùå Health check failed:', error);
              process.exit(1);
            }
          })();
          "
        continue-on-error: true

      - name: Create backup
        if: success()
        run: |
          mkdir -p backups
          timestamp=$(date +%Y%m%d_%H%M%S)
          
          # Backup execution logs
          if [ -d "logs" ]; then
            tar -czf "backups/logs_${timestamp}.tar.gz" logs/
          fi
          
          # Backup config
          if [ -f ".env" ]; then
            cp .env "backups/env_${timestamp}.backup"
          fi
          
          echo "‚úÖ Backup created: ${timestamp}"

      - name: Upload backup artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: radar-backup-${{ github.run_number }}
          path: backups/
          retention-days: 30

      - name: Send notification on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'üö® Radar System Health Check Failed!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  cleanup-old-backups:
    name: Cleanup Old Backups
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/dev'
    needs: health-check
    
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 30);
            
            const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            for (const artifact of artifacts.artifacts) {
              if (artifact.name.startsWith('radar-backup-')) {
                const artifactDate = new Date(artifact.created_at);
                if (artifactDate < cutoffDate) {
                  console.log(`Deleting old artifact: ${artifact.name}`);
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                }
              }
            }
