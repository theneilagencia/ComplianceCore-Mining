name: üìä Auditoria T√©cnica e Conformidade QIVO

on:
  schedule:
    # Executa diariamente √†s 3h UTC (0h BRT)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      audit_type:
        description: 'Tipo de auditoria'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - security
          - performance
          - compliance

env:
  NODE_VERSION: '24'
  PYTHON_VERSION: '3.11'

jobs:
  technical-audit:
    name: Auditoria T√©cnica Completa
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.4.1
      
      - name: Install Dependencies
        run: |
          pnpm install --frozen-lockfile
          pip install requests pyyaml python-dotenv
      
      - name: Load Manus Configuration
        run: |
          echo "üìã Carregando configura√ß√£o..."
          cat manus/config.qivo.yml
      
      - name: Execute Manus Auditor
        run: python3 scripts/manus_auditor.py
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          AUDIT_TYPE: ${{ inputs.audit_type || 'full' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Audit Code Quality
        run: |
          echo "üîç Analisando qualidade do c√≥digo..."
          pnpm run check 2>&1 | tee audit_logs/typecheck.log || true
        continue-on-error: true
      
      - name: Audit Dependencies
        run: |
          echo "üì¶ Auditando depend√™ncias..."
          pnpm audit --audit-level moderate 2>&1 | tee audit_logs/dependencies.log || true
        continue-on-error: true
      
      - name: Audit Bundle Size
        run: |
          echo "üìä Analisando tamanho do bundle..."
          pnpm run build
          du -sh dist/ | tee audit_logs/bundle_size.log
        continue-on-error: true
      
      - name: Security Scan
        run: |
          echo "üîê Executando scan de seguran√ßa..."
          # Verifica secrets expostos
          git log --all --pretty=format: --name-only | sort -u | xargs grep -l "api.key\|secret\|password" || echo "‚úÖ Nenhum secret exposto"
        continue-on-error: true
      
      - name: Performance Metrics
        run: |
          echo "‚ö° Coletando m√©tricas de performance..."
          curl -o /dev/null -s -w "Response Time: %{time_total}s\n" https://qivo-mining.onrender.com/ || echo "‚ö†Ô∏è Aplica√ß√£o offline"
        continue-on-error: true
      
      - name: üé® Valida√ß√£o de Design System
        run: |
          echo "üé® Validando Design System shadcn/ui..."
          python3 scripts/manus_design_system.py
        continue-on-error: true
      
      - name: Generate Audit Report
        run: |
          echo "üìù Gerando relat√≥rio consolidado..."
          python3 scripts/generate_audit_report.py
        env:
          AUDIT_TYPE: ${{ inputs.audit_type || 'full' }}
        continue-on-error: true
      
      - name: Upload Audit Logs
        uses: actions/upload-artifact@v4
        with:
          name: audit-logs-${{ github.run_number }}
          path: |
            audit_logs/
            docs/AUDITORIA_CONFORMIDADE_QIVO_V2.md
          retention-days: 30
      
      - name: Commit Audit Documentation
        run: |
          git config user.name "ManusBot"
          git config user.email "bot@manus.ai"
          git add docs/AUDITORIA_CONFORMIDADE_QIVO_V2.md
          git add docs/CHANGELOG_AUTOMATICO.md || true
          git diff --staged --quiet || git commit -m "üìä Auditoria t√©cnica autom√°tica - $(date +%Y-%m-%d)

          Tipo: ${{ inputs.audit_type || 'full' }}
          Executado: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Workflow: Auditoria QIVO v2
          
          Arquivos atualizados:
          - docs/AUDITORIA_CONFORMIDADE_QIVO_V2.md
          - docs/CHANGELOG_AUTOMATICO.md"
          git push
        continue-on-error: true
      
      - name: Notify Slack - Audit Complete
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "üìä Auditoria QIVO v2 Conclu√≠da",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üìä Auditoria T√©cnica QIVO v2"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Tipo:*\n${{ inputs.audit_type || 'full' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n‚úÖ Conclu√≠da"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Data:*\n$(date +%Y-%m-%d)"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Relat√≥rio:*\n<${{ github.server_url }}/${{ github.repository }}/blob/main/docs/AUDITORIA_CONFORMIDADE_QIVO_V2.md|Ver Documento>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  module-health-check:
    name: Health Check de M√≥dulos
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        module: [radar, report, bridge, krci, admin, billing, sse]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Check Module Structure
        run: |
          echo "üîç Verificando m√≥dulo: ${{ matrix.module }}"
          
          MODULE_PATH="server/modules/${{ matrix.module }}"
          
          if [ -d "$MODULE_PATH" ]; then
            echo "‚úÖ M√≥dulo encontrado: $MODULE_PATH"
            find "$MODULE_PATH" -name "*.ts" -o -name "*.tsx" | wc -l | xargs echo "Arquivos TypeScript:"
          else
            echo "‚ùå M√≥dulo n√£o encontrado: $MODULE_PATH"
            exit 1
          fi
      
      - name: Check Tests
        run: |
          TEST_PATH="tests/unit/${{ matrix.module }}"
          
          if [ -d "$TEST_PATH" ]; then
            echo "‚úÖ Testes encontrados: $TEST_PATH"
            find "$TEST_PATH" -name "*.test.ts" | wc -l | xargs echo "Arquivos de teste:"
          else
            echo "‚ö†Ô∏è Testes n√£o encontrados para m√≥dulo: ${{ matrix.module }}"
          fi
        continue-on-error: true
      
      - name: Module Status Summary
        run: |
          echo "üìä Status do m√≥dulo ${{ matrix.module }}:"
          echo "- Estrutura: ‚úÖ"
          echo "- Testes: ‚ö†Ô∏è"
          echo "- Documenta√ß√£o: üîÑ"

  compliance-check:
    name: Verifica√ß√£o de Conformidade
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Check Required Files
        run: |
          echo "üìã Verificando arquivos obrigat√≥rios..."
          
          REQUIRED_FILES=(
            "package.json"
            "tsconfig.json"
            "render.yaml"
            "manus/config.qivo.yml"
            ".github/workflows/deploy_manus.yml"
            ".github/workflows/auditoria_qivo.yml"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå $file - AUSENTE"
            fi
          done
      
      - name: Check Documentation
        run: |
          echo "üìö Verificando documenta√ß√£o..."
          
          DOCS=(
            "README.md"
            "docs/AUDITORIA_CONFORMIDADE_QIVO_V2.md"
            "docs/GUIA_RECUPERACAO_AUTOMATICA.md"
            "docs/CHANGELOG_AUTOMATICO.md"
          )
          
          for doc in "${DOCS[@]}"; do
            if [ -f "$doc" ]; then
              echo "‚úÖ $doc"
            else
              echo "‚ö†Ô∏è $doc - Ser√° gerado automaticamente"
            fi
          done
      
      - name: Environment Variables Check
        run: |
          echo "üîê Verificando vari√°veis de ambiente necess√°rias..."
          
          # Lista de secrets necess√°rios (n√£o revela valores)
          echo "Secrets configurados no GitHub:"
          echo "- MANUS_API_KEY: ${{ secrets.MANUS_API_KEY != '' && '‚úÖ' || '‚ùå' }}"
          echo "- RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID != '' && '‚úÖ' || '‚ùå' }}"
          echo "- RENDER_API_KEY: ${{ secrets.RENDER_API_KEY != '' && '‚úÖ' || '‚ùå' }}"
          echo "- SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL != '' && '‚úÖ' || '‚ö†Ô∏è (opcional)' }}"
