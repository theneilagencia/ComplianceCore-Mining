name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_backup:
        description: 'Skip database backup'
        required: false
        default: 'false'

env:
  PROJECT_ID: qivo-mining-prod
  REGION: us-central1
  SERVICE_NAME: qivo-mining
  DB_INSTANCE: qivo-mining-db
  GCS_BUCKET: qivo-mining-uploads

jobs:
  deploy:
    name: Build and Deploy to Cloud Run
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker

      - name: Create database backup
        if: github.event.inputs.skip_backup != 'true'
        run: |
          echo "Creating database backup..."
          BACKUP_ID=$(gcloud sql backups create \
            --instance=${{ env.DB_INSTANCE }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(id)" 2>&1 | tail -n 1)
          echo "Backup created: ID $BACKUP_ID"
          echo "BACKUP_ID=$BACKUP_ID" >> $GITHUB_ENV

      - name: Setup GCS Bucket
        run: |
          echo "Checking GCS bucket..."
          if gsutil ls -b gs://${{ env.GCS_BUCKET }} &> /dev/null; then
            echo "Bucket already exists"
          else
            echo "Creating bucket..."
            gsutil mb -p ${{ env.PROJECT_ID }} -l ${{ env.REGION }} gs://${{ env.GCS_BUCKET }}
            
            # Set CORS
            cat > /tmp/cors.json <<EOF
          [
            {
              "origin": ["https://www.qivomining.com", "https://qivo-mining-586444405059.us-central1.run.app"],
              "method": ["GET", "PUT", "POST", "DELETE"],
              "responseHeader": ["Content-Type", "Access-Control-Allow-Origin"],
              "maxAgeSeconds": 3600
            }
          ]
          EOF
            gsutil cors set /tmp/cors.json gs://${{ env.GCS_BUCKET }}
            rm /tmp/cors.json
            echo "Bucket created and configured"
          fi

      - name: Build and push Docker image
        run: |
          echo "Building Docker image..."
          IMAGE_TAG="v$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}"
          
          gcloud builds submit \
            --tag=gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:$IMAGE_TAG \
            --tag=gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest \
            --project=${{ env.PROJECT_ID }} \
            --timeout=25m \
            --machine-type=e2-highcpu-8
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy to Cloud Run
        run: |
          echo "Deploying to Cloud Run..."
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=2Gi \
            --cpu=2 \
            --timeout=300 \
            --max-instances=10 \
            --min-instances=0 \
            --set-env-vars=NODE_ENV=production,PORT=8080,GCS_BUCKET=${{ env.GCS_BUCKET }},DISABLE_DIAGNOSTIC_CRON=true,DISABLE_ALL_CRONS=true \
            --set-secrets=DATABASE_URL=DATABASE_URL:latest,JWT_SECRET=JWT_SECRET:latest,SESSION_SECRET=SESSION_SECRET:latest,GOOGLE_OAUTH_CLIENT_ID=GOOGLE_OAUTH_CLIENT_ID:latest,GOOGLE_OAUTH_CLIENT_SECRET=GOOGLE_OAUTH_CLIENT_SECRET:latest,STRIPE_PUBLISHABLE_KEY=STRIPE_PUBLISHABLE_KEY:latest,STRIPE_SECRET_KEY=STRIPE_SECRET_KEY:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest \
            --project=${{ env.PROJECT_ID }}

      - name: Run database migration
        run: |
          echo "Running database migration..."
          MIGRATION_JOB="qivo-migration-$(date +%Y%m%d-%H%M%S)"
          
          # Create migration job
          gcloud run jobs create $MIGRATION_JOB \
            --image=gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }} \
            --region=${{ env.REGION }} \
            --set-secrets=DATABASE_URL=DATABASE_URL:latest \
            --command="npm" \
            --args="run,db:push" \
            --max-retries=0 \
            --task-timeout=10m \
            --project=${{ env.PROJECT_ID }} \
            --quiet
          
          # Execute migration
          gcloud run jobs execute $MIGRATION_JOB \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --wait
          
          # Show logs
          echo "Migration logs:"
          gcloud logging read "resource.type=cloud_run_job AND resource.labels.job_name=$MIGRATION_JOB" \
            --limit=30 \
            --format="value(textPayload)" \
            --project=${{ env.PROJECT_ID }}
          
          # Cleanup
          gcloud run jobs delete $MIGRATION_JOB \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --quiet

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")
          
          echo "Service URL: $SERVICE_URL"
          
          # Wait for service to be ready
          sleep 10
          
          # Check health endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL/api/health)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Health check passed (HTTP $HTTP_CODE)"
          else
            echo "❌ Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "========================================="
          echo "Deployment Summary"
          echo "========================================="
          echo "Project: ${{ env.PROJECT_ID }}"
          echo "Service: ${{ env.SERVICE_NAME }}"
          echo "Region: ${{ env.REGION }}"
          echo "Image: gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "Backup ID: ${{ env.BACKUP_ID }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "========================================="
          
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")
          
          echo "Service URL: $SERVICE_URL"
          echo "Health: $SERVICE_URL/api/health"
          echo "========================================="

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Optionally rollback to previous revision
          echo "To rollback, run:"
          echo "gcloud run services update-traffic ${{ env.SERVICE_NAME }} --to-revisions=PREVIOUS=100 --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }}"
