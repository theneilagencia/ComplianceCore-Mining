name: "üöÄ Deploy to Render"

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: "Trigger Render Deployment"
    runs-on: ubuntu-latest

    steps:
      - name: "üß© Checkout repository"
        uses: actions/checkout@v4

      - name: "üß† Show Git info"
        run: |
          echo "‚úÖ Branch: ${{ github.ref }}"
          echo "‚úÖ Commit: ${{ github.sha }}"
          echo "‚úÖ Actor: ${{ github.actor }}"
          echo "‚úÖ Repository: ${{ github.repository }}"

      - name: "üöÄ Trigger Render deploy"
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "üîó Triggering Render deploy..."
          
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "‚ùå ERROR: Secret RENDER_DEPLOY_HOOK is missing!"
            exit 1
          fi
          
          echo "üìç Deploy hook URL configured (length: ${#RENDER_DEPLOY_HOOK} chars)"
          
          # Fazer requisi√ß√£o com verbose para debug
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/render_response.json \
            -X POST \
            -H "Content-Type: application/json" \
            --max-time 30 \
            "$RENDER_DEPLOY_HOOK" || echo "000")
          
          echo "üìä HTTP Response Code: $HTTP_CODE"
          
          if [ -f /tmp/render_response.json ]; then
            echo "üìÑ Response body:"
            cat /tmp/render_response.json
          else
            echo "‚ö†Ô∏è No response file created"
          fi
          
          # Considerar 200, 201, 202 como sucesso
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "202" ]; then
            echo "‚úÖ Deploy triggered successfully on Render!"
            exit 0
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "‚ùå Failed to connect to Render (network/timeout error)"
            exit 1
          else
            echo "‚ùå Failed to trigger Render deploy (HTTP $HTTP_CODE)"
            exit 1
          fi
